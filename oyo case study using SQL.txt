-- CREATING A TABLE FOR OYO ROOMS
CREATE TABLE OYO_HOTELS(
    BOOKING_ID int NOT NULL,
   CUSTOMER_ID bigint,
    STATUS text,
   CHECK_IN date,
    CHECK_OUT date ,
   NO_OF_ROOMS int,
    HOTEL_ID int,
    AMOUNT int,
   DISCOUNT float, 
   DATE_OF_BOOKING date);

--IMPORTING DATA FROM TABLE OYO_HOTELS
COPY OYO_HOTELS
FROM 'C:\Program Files\PostgreSQL\14\data\oyo data analysis\Oyo hotels.csv'
DELIMITER ',' CSV HEADER;

SELECT *
FROM OYO_HOTELS

--CREATING TABLE FOR CITY_HOTELS
CREATE TABLE CITY_HOTELS(
    HOTEL_ID int NOT NULL,
    CITY text)

--COPYING DATA FROM CITY_HOTELS
COPY CITY_HOTELS
FROM 'C:\Program Files\PostgreSQL\14\data\oyo data analysis\City hotels.csv'
DELIMITER ',' CSV HEADER;
 
SELECT *
FROM CITY_HOTELS

-- EXPLORATORY DATA ANALYSIS

--No of hotels in the dataset
SELECT COUNT(DISTINCT HOTEL_ID)
FROM OYO_HOTELS

--No of hotles in each cities
SELECT CITY,
	COUNT(DISTINCT HOTEL_ID) AS NO_OF_HOTELS
FROM CITY_HOTELS
GROUP BY CITY
ORDER BY NO_OF_HOTELS DESC

-- AVERAGE ROOM RATES in DIFFERENT CITIES

-- creating a view
CREATE VIEW RATES AS
SELECT CITY,
	CASE
					WHEN NO_OF_ROOMS = 1 THEN (AMOUNT / (CHECK_OUT::DATE - CHECK_IN::DATE))
					ELSE (AMOUNT / NO_OF_ROOMS / (CHECK_OUT::DATE - CHECK_IN::DATE))
	END AS RATE
FROM OYO_HOTELS O
LEFT JOIN CITY_HOTELS C ON O.HOTEL_ID = C.HOTEL_ID

--Getting the average rate 
SELECT CITY,
	ROUND(AVG(RATE),0)
FROM RATES
GROUP BY CITY
ORDER BY AVG(RATE) DESC

--CANCELLATION RATE
SELECT CITY,
	COUNT(*)
FROM OYO_HOTELS O
LEFT JOIN CITY_HOTELS C ON O.HOTEL_ID = C.HOTEL_ID
WHERE STATUS = 'Cancelled'
GROUP BY CITY
ORDER BY CITY ASC

--No of bookings in each city during first quarter of the year 2017
SELECT CITY,
	COUNT(*) AS NO_OF_BOOKINGS
FROM OYO_HOTELS O,CITY_HOTELS C
WHERE EXTRACT(MONTH FROM DATE_OF_BOOKING) BETWEEN 1 AND 3
AND O.HOTEL_ID = C.HOTEL_ID
GROUP BY CITY

--No of bookings made in the month of januray , febuary andm march
SELECT COUNT(*),
	EXTRACT(MONTH FROM DATE_OF_BOOKING) AS MONTH
FROM OYO_HOTELS O,
	CITY_HOTELS C
WHERE O.HOTEL_ID = C.HOTEL_ID
GROUP BY MONTH
ORDER BY MONTH ASC

--no of bookings in each city in the month of january , febuary, and march
SELECT CITY,
	COUNT(*),
	EXTRACT(MONTH FROM DATE_OF_BOOKING) AS MONTH
FROM OYO_HOTELS O,
	CITY_HOTELS C
WHERE O.HOTEL_ID = C.HOTEL_ID
GROUP BY MONTH, CITY
ORDER BY MONTH ASC

--Average discount offered in each  month

SELECT CONCAT(ROUND(CAST(AVG(DISCOUNT / AMOUNT) * 100 AS numeric),2),'%') AS AVG_DISCOUNT,
	EXTRACT(MONTH FROM DATE_OF_BOOKING) AS MONTH
FROM OYO_HOTELS O
GROUP BY MONTH
ORDER BY MONTH ASC


--No of nights stayed by the customers
--using age function
SELECT COUNT(*) AS NO_OF_CUSTOMER_STAYED,
	AGE(CHECK_OUT,CHECK_IN) AS NO_OF_NIGHTS
FROM OYO_HOTELS
GROUP BY NO_OF_NIGHTS
ORDER BY NO_OF_CUSTOMER_STAYED DESC

--using "_" operator
SELECT COUNT(*) AS NO_OF_CUSTOMER_STAYED,
	CHECK_OUT::DATE - CHECK_IN::DATE AS NO_OF_NIGHTS
FROM OYO_HOTELS
GROUP BY NO_OF_NIGHTS
ORDER BY NO_OF_CUSTOMER_STAYED DESC

--How many customers booked the rooms on the same day
SELECT COUNT(*) AS NO_OF_CUSTOMER
FROM OYO_HOTELS
WHERE AGE(CHECK_IN,DATE_OF_BOOKING) = '00:00:00'

--How many prebookings were made
SELECT COUNT(*) AS NO_OF_CUSTOMER
FROM OYO_HOTELS
WHERE AGE(CHECK_IN,DATE_OF_BOOKING) <> '00:00:00'


--what are the different types of prebookings were made by each of the customer

SELECT COUNT(*) AS NO_OF_CUSTOMER,
	AGE(CHECK_IN,DATE_OF_BOOKING) AS DIFFERENCE_IN_DAYS
FROM OYO_HOTELS
WHERE AGE(CHECK_IN,DATE_OF_BOOKING) <> '00:00:00'
GROUP BY DIFFERENCE_IN_DAYS
ORDER BY NO_OF_CUSTOMER DESC